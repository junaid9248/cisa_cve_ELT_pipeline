# Operator: These are the nodes in a DAG, they represent a task.
# Dependencies: These are specified relationships between operators.
# Tasks: In airflow, a task is the unit of work.
# Task instances: Execution of a task at a specific point in time ie: in a DagRun

from airflow import DAG
from airflow.providers.standard.operators.bash import BashOperator

import logging 
import datetime
import timedelta
from src.config import IS_LOCAL, GH_TOKEN, GCLOUD_BUCKETNAME, GCLOUD_APP_CREDENTIALS, GCLOUD_PROJECTNAME

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# Define the DAG default args
default_args = {
    'owner': 'junaid',
    'retries': 3,
    'retry_delay': timedelta(minutes=5),
    'start-date': datetime(2025, 12, 15),
    'email_on_failure': True,
    'email_on_retry': True
}

env_dict = {
    'PYHTONPATH': '/opt/airflow/dags/repo',
    'IS_LOCAL': IS_LOCAL, 
    'GH_TOKEN': GH_TOKEN, 
    'GCLOUD_BUCKETNAME': GCLOUD_BUCKETNAME, 
    'GCLOUD_APP_CREDENTIALS': GCLOUD_APP_CREDENTIALS, 
    'GCLOUD_PROJECTNAME': GCLOUD_PROJECTNAME,
}


# Defining the DAG
with DAG(
    dag_display_name='cve_elt_pipeline',
    default_args=default_args,
    description='Extract raw cve jsons from CISA Vulnrichment gihtub repo into GCS bucket -> Transform into structured formats and Load into BigQuery-> perform quality checks'

) as dag:
    # Defining the TASKS using operators

    # TASK 1: EXTRACT
    extract_raw_jsons = BashOperator(
        task_id = 'cve_raws_extraction',
        doc_string = 'Extract raw cve jsons from CISA Vulnrichment gihtub repo into GCS bucket',
        bash_command=(
            'cd /opt/airflow/dags/cisa-cve-pipeline_dag.py &&'
            'python -m src.main --cloud'
        ),
        env = env_dict
    ),

    # TASK 2: TRANSFORM
    transform_raw_json = BashOperator(
        task_id = 'cv_raws_transfomrmation',
        doc_string = 'Transform into structured formats',

        bash_command=(
            'cd /opt/airflow/dags/cisa-cve-pipeline_dag.py &&'
            'python -m src.transform'
        )
    )

# Defining the dependencies